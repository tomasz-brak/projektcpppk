# .github/workflows/clang_format_action.yaml
#
# A GitHub Action workflow to manually trigger clang-format on a branch.
# It checks for formatting issues, applies fixes, and commits them back to the branch.

name: 'Clang-Format'

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to run formatting on'
        required: true
        default: 'main'
      commit_message:
        description: 'Custom commit message for formatting changes'
        required: false
        default: 'style: Apply clang-format'

jobs:
  clang-format:
    runs-on: ubuntu-latest
    steps:
      - name: 'Check out target branch'
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 'Install clang-format'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: 'Find C/C++ files'
        id: files
        run: |
          files=$(git ls-files '*.c' '*.cc' '*.cpp' '*.cxx' '*.h' '*.hpp' '*.hh' '*.inl')
          echo "files_to_format<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 'Apply clang-format'
        if: steps.files.outputs.files_to_format != ''
        run: |
          echo "Files to format:"
          echo "${{ steps.files.outputs.files_to_format }}"
          echo "${{ steps.files.outputs.files_to_format }}" | xargs -r clang-format -i -style=file

      - name: 'Commit and push changes'
        if: steps.files.outputs.files_to_format != ''
        run: |
          # Configure git user.
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are any changes to commit.
          if ! git diff --quiet; then
            echo "Formatting changes detected. Committing and pushing..."
            git add -A
            git commit -m "${{ inputs.commit_message }}"
            git push origin HEAD:${{ inputs.branch }}
          else
            echo "No formatting changes needed."
          fi

      - name: 'No files to format'
        if: steps.files.outputs.files_to_format == ''
        run: echo "No source files found to format."
